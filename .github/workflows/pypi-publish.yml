name: Publish to PyPI

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Create temporary pyproject.toml without setuptools-scm
        run: |
          # Backup original
          cp pyproject.toml pyproject.toml.backup
          
          # Create new pyproject.toml with fixed version
          cat > pyproject.toml << 'EOF'
          [build-system]
          requires = ["setuptools>=45", "wheel"]
          build-backend = "setuptools.build_meta"
          
          [project]
          name = "scia"
          version = "$VERSION"
          authors = [
            {name = "Mohammad Ahsan Khodami", email = "ahsan.khodami@gmail.com"},
          ]
          description = "A Comprehensive most updated Python package for Single Case Design Analysis"
          readme = "README.md"
          requires-python = ">=3.9"
          classifiers = [
            "Programming Language :: Python :: 3",
            "License :: OSI Approved :: MIT License",
            "Operating System :: OS Independent",
          ]
          dependencies = [
            "numpy",
            "pandas",
            "matplotlib",
            "scipy",
            "openpyxl",
            "scikit-learn",
            "statsmodels",
          ]
          
          [project.urls]
          "Homepage" = "https://github.com/AhsanKhodami/scia"
          
          [tool.setuptools]
          packages = ["scia"]
          EOF
          
          # Replace $VERSION with actual version
          sed -i "s/\$VERSION/$VERSION/g" pyproject.toml

      - name: Build package
        run: |
          python -m build

      - name: Check built package
        run: |
          pip install twine
          twine check dist/*
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.8.11